---
phase: 02-nonce-csp
plan: 01
type: execute
---

<objective>
Implement Next.js 16 middleware with nonce generation for Content Security Policy headers.

Purpose: Replace unsafe-inline CSP directives with nonce-based security to prevent XSS attacks while maintaining functionality.
Output: Working middleware.ts that generates unique nonces per request and applies strict CSP headers without unsafe-inline.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/security/security-headers.ts

**Constraint from PROJECT.md:**
- All 891 tests must pass after changes
- Zero downtime - changes must be deployable without service interruption
- Bun runtime required for all commands

**Tech stack from codebase:**
- Next.js 16.1.0 App Router
- TypeScript 5.9.3 (strict mode)
- Existing security infrastructure in src/lib/security/

**Current state:**
- `buildEnhancedCSP()` function exists with nonce parameters
- No middleware.ts currently exists
- style-src currently has 'unsafe-inline' fallback

**Next.js 16 CSP pattern from documentation:**
- Middleware generates nonce via crypto.randomUUID()
- Nonce passed via x-nonce header
- CSP header set on both request and response
- Next.js automatically applies nonces to framework scripts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create middleware.ts with nonce generation and CSP headers</name>
  <files>middleware.ts</files>
  <action>Create middleware.ts in project root with Next.js 16 pattern:

1. Import NextRequest, NextResponse from 'next/server'
2. Import buildEnhancedCSP from '@/lib/security/security-headers'
3. Implement middleware function:
   - Generate nonce: `Buffer.from(crypto.randomUUID()).toString('base64')`
   - Create nonces object: `{ scriptNonce: nonce, styleNonce: nonce }` (same nonce for both)
   - Call buildEnhancedCSP(nonces) to get CSP header value
   - Create new Headers from request.headers
   - Set x-nonce header with nonce value
   - Set Content-Security-Policy header with CSP value
   - Create NextResponse.next() with modified request headers
   - Set Content-Security-Policy header on response
   - Return response
4. Export config with matcher that excludes static assets:
   ```typescript
   export const config = {
     matcher: [
       '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
     ],
   }
   ```

Why middleware (not headers in next.config.js): Nonce must be unique per request, requiring dynamic generation in middleware. Static headers in next.config.js cannot generate unique nonces.

Pattern follows Next.js 16 official CSP documentation.</action>
  <verify>Check middleware.ts exists, imports are correct, nonce generation uses crypto.randomUUID(), headers are set on both request and response, config matcher excludes static assets</verify>
  <done>middleware.ts created with nonce generation, CSP header application, and proper matcher configuration</done>
</task>

<task type="auto">
  <name>Task 2: Remove unsafe-inline from style-src in buildEnhancedCSP</name>
  <files>src/lib/security/security-headers.ts</files>
  <action>Update buildEnhancedCSP function to remove 'unsafe-inline' fallback from style-src directive:

Current line:
```typescript
`style-src 'self' 'nonce-${nonces.styleNonce}' https://fonts.googleapis.com 'unsafe-inline'`,
```

Change to:
```typescript
`style-src 'self' 'nonce-${nonces.styleNonce}' https://fonts.googleapis.com`,
```

Rationale: With middleware generating nonces for every request, we no longer need 'unsafe-inline' as a fallback. Next.js 16 automatically applies nonces to inline styles, making unsafe-inline unnecessary and insecure.

Verify no other unsafe-inline directives remain in CSP (script-src should already be nonce-only).</action>
  <verify>Check style-src directive no longer contains 'unsafe-inline', confirm fonts.googleapis.com still present for Google Fonts, verify buildEnhancedCSP still returns string with all required directives</verify>
  <done>unsafe-inline removed from style-src, CSP relies entirely on nonces for inline styles, Google Fonts external stylesheet still allowed</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bun test` shows 891 passing tests, 0 failures
- [ ] `bun run type-check` completes with 0 errors
- [ ] `bun run build` succeeds without errors
- [ ] middleware.ts exists in project root
- [ ] buildEnhancedCSP no longer has unsafe-inline in style-src
</verification>

<success_criteria>

- All tasks completed
- middleware.ts created with Next.js 16 nonce pattern
- Nonce generated uniquely per request
- CSP headers applied via middleware
- unsafe-inline removed from style-src
- All 891 tests passing
- Type checking passes
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-nonce-csp/02-01-SUMMARY.md`:

# Phase 2 Plan 1: CSP Middleware & Nonce Infrastructure Summary

**Implemented Next.js 16 middleware with nonce-based CSP headers, eliminating unsafe-inline**

## Accomplishments

- Created middleware.ts with crypto-based nonce generation
- Applied CSP headers to all requests via middleware
- Removed unsafe-inline from style-src directive
- Configured matcher to exclude static assets
- Maintained compatibility with Google Fonts and Vercel Analytics

## Files Created/Modified

- `middleware.ts` - New file with nonce generation and CSP application
- `src/lib/security/security-headers.ts` - Removed unsafe-inline from buildEnhancedCSP

## Decisions Made

- Used single nonce for both script-src and style-src (Next.js 16 pattern)
- Applied CSP to both request headers (for SSR) and response headers (for client)
- Excluded static assets from middleware via matcher pattern

## Issues Encountered

[Document any CSP violations, build errors, or compatibility issues, or "None"]

## Next Step

Ready for 02-02-PLAN.md: Component Nonce Integration (convert JSON-LD to Server Components, add nonce support)
</output>
