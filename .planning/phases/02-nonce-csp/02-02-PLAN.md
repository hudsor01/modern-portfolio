---
phase: 02-nonce-csp
plan: 02
type: execute
---

<objective>
Convert JSON-LD components to Server Components and integrate nonce support throughout the application.

Purpose: Ensure all inline scripts receive nonces from middleware, enabling strict CSP enforcement.
Output: JSON-LD components as Server Components with nonce integration, zero CSP violations in browser console.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-nonce-csp/02-01-SUMMARY.md
@src/app/layout.tsx
@src/components/seo/json-ld/person-json-ld.tsx

**Dependency from Plan 02-01:**
- middleware.ts generates nonces
- x-nonce header available in requests
- CSP headers enforce nonce-only policy

**Tech stack from codebase:**
- Next.js 16 App Router with React Server Components
- headers() function from 'next/headers' for reading request headers
- JSON-LD structured data in layout

**Current state:**
- PersonJsonLd, WebsiteJsonLd, OrganizationJsonLd, LocalBusinessJsonLd are 'use client' components
- Components use dangerouslySetInnerHTML for JSON-LD script tags
- No nonce currently applied to these scripts

**Next.js 16 pattern:**
- Server Components read nonce from headers() async function
- Pass nonce to Script component via nonce prop
- Framework automatically applies nonces to bundled scripts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert JSON-LD components to Server Components with nonce support</name>
  <files>src/components/seo/json-ld/person-json-ld.tsx, src/components/seo/json-ld/website-json-ld.tsx, src/components/seo/json-ld/organization-json-ld.tsx, src/components/seo/json-ld/local-business-json-ld.tsx</files>
  <action>For each JSON-LD component file:

1. **Remove 'use client' directive** - These become async Server Components
2. **Import headers** - Add `import { headers } from 'next/headers'`
3. **Make component async** - Change `export function ComponentName()` to `export async function ComponentName()`
4. **Read nonce from headers**:
   ```typescript
   const nonce = (await headers()).get('x-nonce')
   ```
5. **Apply nonce to script tag**:
   ```typescript
   return (
     <script
       type="application/ld+json"
       nonce={nonce ?? undefined}
       dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }}
     />
   )
   ```

Apply to all four files:
- src/components/seo/json-ld/person-json-ld.tsx
- src/components/seo/json-ld/website-json-ld.tsx (if exists)
- src/components/seo/json-ld/organization-json-ld.tsx (if exists)
- src/components/seo/json-ld/local-business-json-ld.tsx (if exists)

Why Server Components: Access to headers() function, better performance (no client-side hydration for static JSON-LD), security (nonce applied server-side).

Pattern follows Next.js 16 CSP documentation.</action>
  <verify>Check all JSON-LD files no longer have 'use client', components are async, nonce is read from headers, script tags have nonce attribute</verify>
  <done>All JSON-LD components converted to async Server Components with nonce support</done>
</task>

<task type="auto">
  <name>Task 2: Update root layout to support async JSON-LD components</name>
  <files>src/app/layout.tsx</files>
  <action>Update layout.tsx to support async JSON-LD components:

1. **Check if PersonJsonLd, WebsiteJsonLd, etc. are awaited** - Since they're now async Server Components, they need to be awaited if used directly
2. **Verify no conflicts with 'use client' providers** - JSON-LD components should render in server context before ClientComponentsProvider
3. **Ensure proper placement** - JSON-LD should be in `<head>` section where they currently are

Current structure is already correct (JSON-LD in head, providers wrapping children). Verify no changes needed - async Server Components work automatically in RSC tree.

If any third-party Script components exist (Analytics, GTM), verify they receive nonces. Vercel Analytics already handled by Next.js automatic nonce injection.

No code changes may be needed if structure is already optimal - just verify compatibility.</action>
  <verify>Check layout.tsx still compiles, JSON-LD components render without errors, no 'use client' conflicts, providers still work correctly</verify>
  <done>Root layout verified compatible with async JSON-LD Server Components, no breaking changes introduced</done>
</task>

<task type="auto">
  <name>Task 3: Test CSP enforcement and verify zero violations</name>
  <files>None (verification only)</files>
  <action>Run development server and verify CSP compliance:

1. **Start dev server**: `bun dev`
2. **Open browser** to http://localhost:3000
3. **Open DevTools Console** and check for CSP violations
4. **Check Network tab** - verify Content-Security-Policy header present
5. **Check Response Headers** - verify nonce format `'nonce-{base64}'` in CSP
6. **Test pages**:
   - Home page (/)
   - Project pages (/projects, /projects/[slug])
   - Blog pages (/blog, /blog/[slug])
   - Contact page (/contact)
7. **Look for errors**:
   - "Refused to execute inline script because it violates CSP"
   - "Refused to apply inline style because it violates CSP"
   - Any other CSP-related warnings

Expected: Zero CSP violations. All inline scripts/styles have nonces applied automatically by Next.js or explicitly via our changes.

Run full test suite: `bun test` - All 891 tests must pass.
Run type check: `bun run type-check` - Must complete with 0 errors.
Run build: `bun run build` - Must succeed without errors.</action>
  <verify>Dev server starts without errors, zero CSP violations in browser console, all navigation works, all 891 tests pass, type check passes, build succeeds</verify>
  <done>CSP enforcement verified with zero violations, all tests passing, application fully functional with strict CSP</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bun dev` starts without errors
- [ ] Browser console shows 0 CSP violations
- [ ] Content-Security-Policy header visible in Network tab
- [ ] JSON-LD scripts have nonce attributes in HTML
- [ ] `bun test` shows 891 passing tests, 0 failures
- [ ] `bun run type-check` completes with 0 errors
- [ ] `bun run build` succeeds without errors
</verification>

<success_criteria>

- All tasks completed
- JSON-LD components converted to Server Components
- Nonces applied to all inline scripts
- Zero CSP violations in browser console
- All 891 tests passing
- Type checking passes
- Build succeeds
- Application fully functional with strict CSP
</success_criteria>

<output>
After completion, create `.planning/phases/02-nonce-csp/02-02-SUMMARY.md`:

# Phase 2 Plan 2: Component Nonce Integration Summary

**Converted JSON-LD to Server Components with nonce support, achieving zero CSP violations**

## Accomplishments

- Converted 4 JSON-LD components to async Server Components
- Applied nonces to all inline JSON-LD scripts
- Verified zero CSP violations across all pages
- Maintained backward compatibility with existing providers
- Confirmed automatic nonce injection for framework scripts

## Files Created/Modified

- `src/components/seo/json-ld/person-json-ld.tsx` - Converted to Server Component
- `src/components/seo/json-ld/website-json-ld.tsx` - Converted to Server Component
- `src/components/seo/json-ld/organization-json-ld.tsx` - Converted to Server Component
- `src/components/seo/json-ld/local-business-json-ld.tsx` - Converted to Server Component
- `src/app/layout.tsx` - Verified compatibility (no changes needed)

## Decisions Made

- Used headers() API to read nonces in Server Components
- Kept JSON-LD in Server Component context (not client-side hydrated)
- Relied on Next.js automatic nonce injection for framework scripts

## Issues Encountered

[Document any CSP violations, component errors, or compatibility issues, or "None"]

## Next Phase Readiness

Phase 2 complete. Ready for Phase 3: Improve Type Safety.
No blockers. CSP hardening successful with zero violations and zero downtime.
</output>
