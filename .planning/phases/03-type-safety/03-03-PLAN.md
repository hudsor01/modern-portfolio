# Plan 03-03: Replace Manual Types with Prisma Client

## Objective

Eliminate all duplicate type definitions by using Prisma-generated types directly. Remove all re-export files and redundant manual type definitions. This reduces the codebase from 6,116 lines of manual types to ~1,500 lines by using schema as single source of truth.

## Execution Context

**Tech Stack:**
- TypeScript 5.9.3 (strict mode enabled)
- Prisma ORM with generated client at `prisma/generated/prisma`
- Next.js 16 App Router
- Bun runtime

**Constraints:**
- NO barrel files/re-exports (import directly from Prisma client)
- All 891 tests must pass after changes
- Zero downtime requirement (no breaking API changes)
- Atomic commits: One per task

**Import Path:**
```typescript
// ✅ Correct - direct from Prisma
import type { BlogPost, Author, Project } from '@/prisma/client'
import { Prisma } from '@/prisma/client'

// ❌ Wrong - manual types
import type { BlogPost } from '@/types/blog'
```

## Context

Current state:
- 29 type files totaling 6,116 lines
- Massive duplication: BlogPost defined in 6 files, Project in 3 files
- Prisma already generates all model types, enums, and operation types
- ~80% of manual types duplicate what Prisma provides

Prisma generates:
- All 17 model types (BlogPost, Author, Category, Tag, Project, etc.)
- All 9 enums (PostStatus, ContentType, SecurityEventType, etc.)
- All operation types (CreateInput, UpdateInput, Include, Select, etc.)
- All relation types via Prisma.ModelGetPayload

## Tasks

### Task 1: Audit and identify files to delete

**Goal**: Identify which type files are 100% redundant and can be completely deleted

**Why**: Files that only duplicate Prisma types serve no purpose and should be removed entirely

**Actions:**
1. Analyze each file in `src/types/` to categorize:
   - **DELETE**: 100% duplicates Prisma (blog-database.ts, database.ts, prisma-generated.ts)
   - **KEEP**: Contains unique types not in Prisma (api.ts, ui.ts, forms.ts)
   - **REFACTOR**: Mix of Prisma duplicates + unique types (blog.ts, project.ts)

2. Create deletion list:
   ```bash
   # Files to DELETE (100% redundant):
   src/types/blog-database.ts      # All types from Prisma
   src/types/database.ts           # All types from Prisma
   src/types/prisma-generated.ts   # Duplicates actual Prisma client
   src/types/mock-types.ts         # Should be in test files
   ```

3. Create refactor list:
   ```bash
   # Files to REFACTOR (keep unique types only):
   src/types/blog.ts          # Keep: SEOAnalysis, BlogFilters, BlogListResponse, type guards
   src/types/project.ts       # Keep: DTOs, UI props, normalization functions
   src/types/security.ts      # Keep: RateLimitResult (not in schema)
   src/types/analytics.ts     # Keep: All analytics types (not persisted in DB)
   ```

**Files Modified:**
- None (audit only)

**Verification:**
```bash
# Document findings in task commit
git add .planning/phases/03-type-safety/03-03-PLAN.md
```

**Commit:**
```bash
git commit -m "docs(03-03): audit type files for Prisma replacement

Task 1: Identified files to delete vs refactor
- DELETE: 4 files (blog-database, database, prisma-generated, mock-types)
- REFACTOR: 5 files (blog, project, security, analytics, shared-api)
- KEEP AS-IS: 8 files (api, ui, forms, common, theme, navigation, etc.)

Next: Replace imports with Prisma client"
```

---

### Task 2: Replace blog.ts with Prisma types

**Goal**: Refactor blog.ts from 719 lines to ~150 lines by using Prisma types

**Why**: blog.ts duplicates 80% of what Prisma already provides (BlogPost, Author, Category, Tag, etc.)

**Actions:**

1. **Read current blog.ts** to identify unique types:
   ```bash
   cat src/types/blog.ts | grep "^export"
   ```

2. **Create new blog.ts** with only unique types:
   ```typescript
   // src/types/blog.ts - AFTER refactoring

   /**
    * Blog types - Unique types not provided by Prisma
    * For model types, import directly from @/prisma/client
    */

   import type { BlogPost, Author, Category, Tag } from '@/prisma/client'
   import { Prisma } from '@/prisma/client'

   // ============================================================================
   // UTILITY TYPES - Prisma-based combinations
   // ============================================================================

   export type BlogPostWithRelations = Prisma.BlogPostGetPayload<{
     include: {
       author: true
       category: true
       tags: { include: { tag: true } }
       series: { include: { series: true } }
     }
   }>

   // ============================================================================
   // API/UI TYPES - Not in Prisma schema
   // ============================================================================

   export interface BlogFilters {
     category?: string
     tags?: string[]
     author?: string
     search?: string
     dateFrom?: Date
     dateTo?: Date
     sortBy?: 'publishedAt' | 'title' | 'viewCount' | 'commentCount'
     sortOrder?: 'asc' | 'desc'
   }

   export interface BlogListResponse {
     posts: BlogPost[]
     totalCount: number
     hasMore: boolean
   }

   export interface BlogPostCardProps {
     post: BlogPost
     variant?: 'default' | 'compact' | 'featured'
     showCategory?: boolean
     showTags?: boolean
     showReadingTime?: boolean
     className?: string
   }

   // ============================================================================
   // SEO TYPES - Complex nested types not in schema
   // ============================================================================

   export interface SEOAnalysis {
     score: number
     issues: SEOIssue[]
     opportunities: SEOOpportunity[]
     technicalChecks: TechnicalCheck[]
     contentAnalysis: ContentAnalysis
     keywordAnalysis: KeywordAnalysis
   }

   export interface SEOIssue {
     type: 'error' | 'warning' | 'info'
     category: string
     message: string
     description?: string
     fix?: string
     impact: 'high' | 'medium' | 'low'
   }

   export interface SEOOpportunity {
     type: string
     message: string
     description?: string
     action: string
     potential: 'high' | 'medium' | 'low'
   }

   export interface TechnicalCheck {
     name: string
     status: 'pass' | 'fail' | 'warning'
     message?: string
     details?: Record<string, unknown>
   }

   export interface ContentAnalysis {
     wordCount: number
     readingTime: number
     readabilityScore?: number
     sentimentScore?: number
     keywordDensity: Record<string, number>
     headingStructure: HeadingAnalysis[]
     internalLinks: number
     externalLinks: number
     images: number
     imageAltTexts: number
   }

   export interface HeadingAnalysis {
     level: number
     text: string
     wordCount: number
   }

   export interface KeywordAnalysis {
     primary?: string
     secondary: string[]
     density: Record<string, number>
     prominence: Record<string, number>
     suggestions: string[]
   }

   // ============================================================================
   // TYPE GUARDS - Runtime validation
   // ============================================================================

   export function isBlogPost(value: unknown): value is BlogPost {
     return (
       typeof value === 'object' &&
       value !== null &&
       'id' in value &&
       'title' in value &&
       'content' in value &&
       'status' in value
     )
   }

   export function isAuthor(value: unknown): value is Author {
     return (
       typeof value === 'object' &&
       value !== null &&
       'id' in value &&
       'name' in value &&
       'email' in value
     )
   }
   ```

3. **Update imports in files using blog types**:
   ```bash
   # Find all files importing from @/types/blog
   grep -r "from '@/types/blog'" src --include="*.ts" --include="*.tsx"

   # Update each to use Prisma client for model types
   # Keep @/types/blog imports only for unique types (SEOAnalysis, BlogFilters, etc.)
   ```

4. **Delete old blog-database.ts and database.ts**:
   ```bash
   rm src/types/blog-database.ts
   rm src/types/database.ts
   ```

**Files Modified:**
- `src/types/blog.ts` - Reduced from 719 lines to ~150 lines
- All files importing blog types (update imports)

**Files Deleted:**
- `src/types/blog-database.ts`
- `src/types/database.ts`

**Verification:**
```bash
bun run type-check 2>&1 | grep -E "(blog|error TS)"
# Should show 0 errors
```

**Commit:**
```bash
git add src/types/blog.ts src/types/blog-database.ts src/types/database.ts
git add <files-with-updated-imports>
git commit -m "refactor(03-03): replace blog types with Prisma client

- Reduce blog.ts from 719 to 150 lines (79% reduction)
- Use Prisma client for BlogPost, Author, Category, Tag
- Keep only unique types: SEOAnalysis, BlogFilters, type guards
- Delete blog-database.ts and database.ts (100% redundant)
- Update imports across codebase

Refs: #03-type-safety"
```

---

### Task 3: Replace project.ts with Prisma types

**Goal**: Refactor project.ts to use Prisma Project type

**Why**: Project type is defined in Prisma schema, manual definition is redundant

**Actions:**

1. **Read current project.ts** to identify unique types

2. **Refactor project.ts**:
   ```typescript
   // src/types/project.ts - AFTER refactoring

   /**
    * Project types - Unique types not provided by Prisma
    * For Project model type, import directly from @/prisma/client
    */

   import type { Project } from '@/prisma/client'
   import { Prisma } from '@/prisma/client'

   // Re-export Prisma Project for convenience
   export type { Project }

   // ============================================================================
   // DISPLAY/UI TYPES - Not in schema
   // ============================================================================

   export interface DisplayMetric {
     label: string
     value: string
     iconName: string
   }

   export interface ResultMetric {
     metric: string
     before: string
     after: string
     improvement: string
   }

   export interface Testimonial {
     quote: string
     author: string
     role?: string
     company?: string
     avatar?: string
   }

   export interface ProjectImage {
     url: string
     alt: string
     caption?: string
   }

   // ============================================================================
   // API/QUERY TYPES
   // ============================================================================

   export interface ProjectFilters {
     category?: string
     tags?: string[]
     featured?: boolean
     search?: string
   }

   export interface ProjectsResponse {
     projects: Project[]
     totalCount: number
     hasMore: boolean
   }

   // ============================================================================
   // UTILITY FUNCTIONS
   // ============================================================================

   export function normalizeProjectForDisplay(project: Project): Project {
     // Function stays as-is
   }
   ```

3. **Update imports across codebase**:
   ```bash
   # Find files importing Project from manual types
   grep -r "from '@/types/project'" src --include="*.ts" --include="*.tsx"

   # Update to use Prisma client
   # OLD: import type { Project } from '@/types/project'
   # NEW: import type { Project } from '@/prisma/client'
   ```

**Files Modified:**
- `src/types/project.ts` - Reduced significantly
- All files importing Project type

**Verification:**
```bash
bun run type-check 2>&1 | grep -E "(project|Project|error TS)"
```

**Commit:**
```bash
git add src/types/project.ts <files-with-updated-imports>
git commit -m "refactor(03-03): replace Project type with Prisma client

- Use Prisma client for Project model type
- Keep only unique types: DisplayMetric, ResultMetric, Testimonial
- Update imports across codebase to use @/prisma/client

Refs: #03-type-safety"
```

---

### Task 4: Replace security and other types with Prisma

**Goal**: Replace SecurityEvent and other Prisma model types with client imports

**Why**: SecurityEvent is in Prisma schema, manual definition is redundant

**Actions:**

1. **Refactor security.ts**:
   ```typescript
   // src/types/security.ts - AFTER refactoring

   /**
    * Security types - Unique types not provided by Prisma
    * For SecurityEvent, import from @/prisma/client
    */

   import type { SecurityEvent } from '@/prisma/client'

   // Re-export for convenience
   export type { SecurityEvent }

   // ============================================================================
   // RATE LIMITING - Not in schema (runtime types)
   // ============================================================================

   export interface RateLimitResult {
     success: boolean
     limit: number
     remaining: number
     reset: number
     retryAfter?: number
   }

   export interface EnhancedRateLimitConfig {
     max: number
     window: number
     keyPrefix?: string
   }

   export interface RateLimitAnalytics {
     totalRequests: number
     blockedRequests: number
     topOffenders: Array<{ ip: string; count: number }>
   }
   ```

2. **Update security-event-logger.ts**:
   ```bash
   # Update lib/security/security-event-logger.ts to import from Prisma
   # OLD: Uses inline types or manual imports
   # NEW: import type { SecurityEvent, SecurityEventType, SecuritySeverity } from '@/prisma/client'
   ```

3. **Update ContactSubmission types**:
   ```bash
   # Remove manual ContactSubmission/ContactResponseDTO from lib/dto/contact-dto.ts
   # Use Prisma ContactSubmission directly
   ```

**Files Modified:**
- `src/types/security.ts`
- `src/lib/security/security-event-logger.ts`
- `src/lib/dto/contact-dto.ts`

**Verification:**
```bash
bun run type-check 2>&1 | grep -E "(security|Security|error TS)"
```

**Commit:**
```bash
git add src/types/security.ts src/lib/security/security-event-logger.ts src/lib/dto/contact-dto.ts
git commit -m "refactor(03-03): replace security types with Prisma client

- Use Prisma SecurityEvent, SecurityEventType, SecuritySeverity
- Use Prisma ContactSubmission directly
- Keep only runtime types: RateLimitResult, RateLimitAnalytics
- Update imports across security modules

Refs: #03-type-safety"
```

---

### Task 5: Delete duplicate and redundant files

**Goal**: Remove all files that are now 100% redundant

**Why**: After refactoring, several type files contain nothing unique and should be deleted

**Actions:**

1. **Delete redundant files**:
   ```bash
   rm src/types/prisma-generated.ts  # Duplicates actual Prisma client
   rm src/types/mock-types.ts        # Should be in test files
   ```

2. **Move test types to test directory** (if mock-types.ts has useful types):
   ```bash
   # If mock-types.ts has test utilities, move to src/test/
   # Otherwise, delete entirely
   ```

3. **Check for empty/unused lib subdirectories**:
   ```bash
   # Check if lib/dto/ and lib/forms/*-types.ts can be deleted
   ls -la src/lib/dto/
   ls -la src/lib/forms/

   # Delete if redundant after refactoring
   ```

**Files Deleted:**
- `src/types/prisma-generated.ts`
- `src/types/mock-types.ts`
- Potentially: `src/lib/dto/contact-dto.ts` (if fully replaced)
- Potentially: `src/lib/forms/form-types.ts` (if duplicate of types/forms.ts)
- Potentially: `src/lib/forms/tanstack-form-types.ts` (if duplicate)

**Verification:**
```bash
# Ensure no imports reference deleted files
grep -r "prisma-generated\|mock-types" src --include="*.ts" --include="*.tsx"
# Should return 0 results

# Check for orphaned imports
bun run type-check
```

**Commit:**
```bash
git add src/types/ src/lib/
git commit -m "refactor(03-03): delete redundant type files

- Delete prisma-generated.ts (duplicates Prisma client)
- Delete mock-types.ts (move to test files)
- Delete lib/dto/contact-dto.ts (use Prisma ContactSubmission)
- Delete lib/forms/*-types.ts (duplicates types/forms.ts)

Reduced type files from 29 to ~15

Refs: #03-type-safety"
```

---

### Task 6: Update shared-api.ts to use Prisma types

**Goal**: Refactor shared-api.ts to use Prisma types as base

**Why**: shared-api.ts has DTOs that should extend Prisma types, not duplicate them

**Actions:**

1. **Refactor shared-api.ts**:
   ```typescript
   // src/types/shared-api.ts - AFTER refactoring

   /**
    * Shared API types - DTOs and API contracts
    * Base types come from Prisma, extended for API needs
    */

   import type { BlogPost, Category, Tag, Project } from '@/prisma/client'
   import type { Prisma } from '@/prisma/client'

   // ============================================================================
   // BLOG API TYPES - DTOs for API responses
   // ============================================================================

   // Use Prisma type as base, add computed fields
   export interface BlogPostData extends BlogPost {
     category?: Category | null
     tags?: Tag[]
     readTime?: string
     excerpt?: string
   }

   export interface BlogPostSummary {
     id: string
     title: string
     slug: string
     excerpt: string
     publishedAt: Date | null
     readingTime: number
     category?: Category | null
   }

   export interface BlogCategoryData extends Category {
     postCount: number
   }

   export interface BlogTagData extends Tag {
     postCount: number
   }

   // ============================================================================
   // FORM TYPES - From Zod schemas
   // ============================================================================

   export interface ContactFormData {
     name: string
     email: string
     company?: string
     message: string
   }

   // ============================================================================
   // API FILTERS/SORTS
   // ============================================================================

   export interface BlogPostFilters {
     status?: string
     category?: string
     tag?: string
     search?: string
   }

   export interface BlogPostSort {
     field: 'publishedAt' | 'title' | 'viewCount'
     order: 'asc' | 'desc'
   }
   ```

2. **Update test factories**:
   ```bash
   # Update src/test/blog-factories.ts to import BlogPostSummary from shared-api
   # Ensure it uses Prisma types as base
   ```

**Files Modified:**
- `src/types/shared-api.ts`
- `src/test/blog-factories.ts`

**Verification:**
```bash
bun run type-check 2>&1 | grep -E "(shared-api|BlogPost|error TS)"
```

**Commit:**
```bash
git add src/types/shared-api.ts src/test/blog-factories.ts
git commit -m "refactor(03-03): refactor shared-api to extend Prisma types

- Use Prisma BlogPost, Category, Tag as base types
- DTOs extend Prisma types with computed fields
- Remove duplicate type definitions
- Update test factories to use new structure

Refs: #03-type-safety"
```

---

### Task 7: Update all enums to use Prisma enums

**Goal**: Replace all manual enum imports with Prisma client imports

**Why**: Prisma generates all enums, manual imports are redundant

**Actions:**

1. **Find all enum imports**:
   ```bash
   grep -r "PostStatus\|ContentType\|SecurityEventType\|SubmissionStatus" src \
     --include="*.ts" --include="*.tsx" | grep "import"
   ```

2. **Update enum imports**:
   ```typescript
   // ❌ OLD - from manual types or lib/prisma-types
   import { PostStatus, ContentType } from '@/lib/prisma-types'
   import { SecurityEventType } from '@/types/security'

   // ✅ NEW - directly from Prisma client
   import { PostStatus, ContentType, SecurityEventType } from '@/prisma/client'
   ```

3. **Delete lib/prisma-types.ts if it exists** (re-export file):
   ```bash
   # This file should not exist based on user requirement
   rm src/lib/prisma-types.ts 2>/dev/null || true
   ```

4. **Check types/blog.ts for enum re-exports**:
   ```bash
   # Remove any enum re-exports from blog.ts
   # Users should import enums directly from Prisma client
   ```

**Files Modified:**
- All files importing enums (5-10 files estimated)
- `src/types/blog.ts` (remove enum re-exports)

**Files Deleted:**
- `src/lib/prisma-types.ts` (if exists)

**Verification:**
```bash
# Ensure all enum imports come from Prisma client
grep -r "from '@/lib/prisma-types'" src --include="*.ts" --include="*.tsx"
# Should return 0 results

bun run type-check
```

**Commit:**
```bash
git add <all-files-with-updated-enum-imports>
git commit -m "refactor(03-03): use Prisma client for all enum imports

- Replace all enum imports to use @/prisma/client
- Remove lib/prisma-types.ts re-export file
- Remove enum re-exports from types/blog.ts
- Direct imports: PostStatus, ContentType, SecurityEventType, etc.

Refs: #03-type-safety"
```

---

### Task 8: Verify and test all changes

**Goal**: Run full type check and test suite to confirm refactoring is successful

**Why**: Ensure no regressions from this large refactoring

**Actions:**

1. **Run type check**:
   ```bash
   bun run type-check
   ```
   Expected: 0 errors (down from 29 original errors)

2. **Run test suite**:
   ```bash
   bun test
   ```
   Expected: All 891 tests passing

3. **Count remaining type lines**:
   ```bash
   wc -l src/types/*.ts 2>/dev/null | tail -1
   ```
   Expected: ~1,500 lines (down from 6,116)

4. **Verify no orphaned imports**:
   ```bash
   # Check for imports from deleted files
   grep -r "blog-database\|prisma-generated\|mock-types" src --include="*.ts" --include="*.tsx"
   # Should return 0 results
   ```

5. **Check for remaining manual BlogPost definitions**:
   ```bash
   grep -r "^export.*BlogPost" src/types --include="*.ts"
   # Should only find re-exports from Prisma, no manual definitions
   ```

6. **Build verification**:
   ```bash
   bun run build
   ```
   Expected: Successful build

**Files Modified:**
- None (verification only)

**Verification:**
- Type check: 0 errors
- Tests: 891/891 passing
- Build: Success
- Type lines: ~1,500 (75% reduction)
- No orphaned imports
- No duplicate type definitions

**Commit:**
None (verification task)

---

## Success Criteria

- [ ] All Prisma model types imported from `@/prisma/client`
- [ ] All enums imported from `@/prisma/client`
- [ ] No re-export files (lib/prisma-types.ts deleted)
- [ ] 4+ redundant type files deleted (blog-database, database, prisma-generated, mock-types)
- [ ] Type lines reduced from 6,116 to ~1,500 (75% reduction)
- [ ] `bun run type-check` shows 0 errors
- [ ] All 891 tests passing
- [ ] `bun run build` succeeds
- [ ] No imports from deleted files
- [ ] 8 atomic commits (7 task commits + metadata)

## Output

**Modified Files:**
- `src/types/blog.ts` - Reduced from 719 to ~150 lines
- `src/types/project.ts` - Reduced significantly
- `src/types/security.ts` - Refactored to keep only runtime types
- `src/types/shared-api.ts` - Refactored to extend Prisma types
- All files with updated imports (20-30 files)

**Deleted Files:**
- `src/types/blog-database.ts`
- `src/types/database.ts`
- `src/types/prisma-generated.ts`
- `src/types/mock-types.ts`
- `src/lib/prisma-types.ts` (if exists)
- `src/lib/dto/contact-dto.ts` (potentially)
- `src/lib/forms/form-types.ts` (potentially)
- `src/lib/forms/tanstack-form-types.ts` (potentially)

**Metrics:**
- Type files: 29 → ~15 (48% reduction)
- Type lines: 6,116 → ~1,500 (75% reduction)
- Duplicate definitions: 20+ → 0
- Single source of truth: Prisma schema
- Breaking changes: 0

**Benefits:**
- Faster builds (less code to parse)
- Single source of truth (schema drives types)
- No duplication or drift
- Easier maintenance (update schema, types auto-update)
- Smaller bundle size
