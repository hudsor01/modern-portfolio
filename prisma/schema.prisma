// This is your Prisma schema file for the modern portfolio blog system.
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["fullTextSearchPostgres", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [citext]
}

model BlogPost {
  id          String          @id @default(cuid())
  title       String
  slug        String          @unique @db.Citext
  excerpt     String?         @db.Text
  content     String          @db.Text
  contentType ContentType     @default(MARKDOWN)
  status      PostStatus      @default(DRAFT)
  metaTitle       String?
  metaDescription String?       @db.VarChar(160)
  keywords        String[]
  canonicalUrl    String?
  ogTitle       String?
  ogDescription String?         @db.VarChar(300)
  ogImage       String?
  twitterTitle  String?
  twitterDescription String?    @db.VarChar(200)
  twitterImage  String?
  featuredImage   String?
  featuredImageAlt String?
  readingTime     Int?            // in minutes
  wordCount       Int?
  publishedAt     DateTime?
  scheduledAt     DateTime?
  archivedAt      DateTime?
  deletedAt       DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  authorId        String
  author          Author          @relation(fields: [authorId], references: [id])
  categoryId      String?
  category        Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags            PostTag[]
  viewCount       Int             @default(0)
  likeCount       Int             @default(0)
  shareCount      Int             @default(0)
  commentCount    Int             @default(0)
  views           PostView[]
  interactions    PostInteraction[]
  
  @@map("blog_posts")
  @@index([status, publishedAt(sort: Desc)]) // Main query: posts by status and date
  @@index([authorId]) // For author pages
  @@index([categoryId]) // For category pages
}

model Author {
  id              String          @id @default(cuid())
  name            String
  email           String          @unique @db.Citext
  slug            String          @unique @db.Citext
  bio             String?         @db.Text
  avatar          String?
  website         String?
  twitter         String?
  linkedin        String?
  github          String?
  metaDescription String?         @db.VarChar(160)
  totalViews      Int             @default(0)
  totalPosts      Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  posts           BlogPost[]

  @@map("authors")
}

model Category {
  id              String          @id @default(cuid())
  name            String          @unique
  slug            String          @unique @db.Citext
  description     String?         @db.Text
  color           String?         // Hex color for UI
  icon            String?         // Icon name or URL
  metaTitle       String?
  metaDescription String?         @db.VarChar(160)
  keywords        String[]
  parentId        String?
  parent          Category?       @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        Category[]      @relation("CategoryHierarchy")
  postCount       Int             @default(0)
  totalViews      Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  posts           BlogPost[]
  
  @@map("categories")
  @@index([parentId]) // For hierarchical queries
}

model Tag {
  id              String          @id @default(cuid())
  name            String          @unique
  slug            String          @unique @db.Citext
  description     String?
  color           String?         // Hex color for UI
  metaDescription String?         @db.VarChar(160)
  postCount       Int             @default(0)
  totalViews      Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  posts           PostTag[]
  
  @@map("tags")
}

model PostTag {
  postId    String
  tagId     String
  
  post      BlogPost        @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag       Tag             @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  createdAt DateTime        @default(now())
  
  @@id([postId, tagId])
  @@index([tagId])
  @@map("post_tags")
}

model PostView {
  id              String          @id @default(cuid())
  postId          String
  visitorId       String?         // Anonymous visitor ID
  sessionId       String?         // Session identifier
  ipAddress       String?         @db.Inet
  userAgent       String?         @db.Text
  referer         String?
  country         String?
  region          String?
  city            String?
  readingTime     Int?            // Time spent on post in seconds
  scrollDepth     Float?          // Percentage of post scrolled
  viewedAt        DateTime        @default(now())
  post            BlogPost        @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  @@map("post_views")
  @@index([postId]) // For querying views by post
  @@index([viewedAt(sort: Desc)]) // For date range queries (most recent first)
  @@index([postId, viewedAt(sort: Desc)]) // For post-specific date range queries
  @@index([visitorId]) // For visitor-specific queries
  @@index([country]) // For geographic queries
  @@index([sessionId]) // For session-based analysis
  @@index([viewedAt, country]) // For location and date range combined queries
}

model PostInteraction {
  id              String          @id @default(cuid())
  postId          String
  type            InteractionType
  visitorId       String?
  sessionId       String?
  value           String?         // Additional data (e.g., shared platform)
  metadata        Json?           // Flexible metadata storage
  createdAt       DateTime        @default(now())
  post            BlogPost        @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  @@map("post_interactions")
  @@index([postId, type])
  @@index([createdAt(sort: Desc)])
}

enum PostStatus {
  DRAFT
  REVIEW
  SCHEDULED
  PUBLISHED
  ARCHIVED
  DELETED
}

enum ContentType {
  MARKDOWN
  HTML
  RICH_TEXT
}

enum InteractionType {
  LIKE
  SHARE
  COMMENT
  BOOKMARK
  SUBSCRIBE
  DOWNLOAD
}

model Project {
  id              String          @id @default(cuid())
  slug            String          @unique @db.Citext
  title           String
  description     String          @db.Text
  longDescription String?         @db.Text    // Extended project description
  content         String?         @db.Text    // Full markdown content for case studies
  image           String                      // Project screenshot/hero image
  link            String?                     // Live demo URL
  github          String?                     // GitHub repository URL
  category        String                      // e.g., "Revenue Operations", "Marketing"
  tags            String[]                    // Array of technology and feature tags
  featured        Boolean         @default(false)
  client          String?                     // Client name
  role            String?                     // Role in project
  duration        String?                     // Project duration (e.g., "6 months")
  year            Int?                        // Project year
  caseStudyUrl    String?                     // URL to case study page
  impact          Json?                       // string[] - Impact statements
  results         Json?                       // Array<{metric, before, after, improvement}>
  displayMetrics  Json?                       // Array<{label, value, iconName}>
  metrics         Json?                       // Record<string, string>
  testimonial     Json?                       // {quote, author, role?, company?, avatar?}
  gallery         Json?                       // Array<{url, alt, caption?}>
  details         Json?                       // {challenge, solution, impact}
  charts          Json?                       // Array<{type, title, dataKey}>
  viewCount       Int             @default(0)
  clickCount      Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("projects")
  @@index([category])
  @@index([featured])
  @@index([createdAt(sort: Desc)])
  @@index([year])
}


model ContactSubmission {
  id              String          @id @default(cuid())
  name            String
  email           String
  company         String?         // Optional - company/organization name
  phone           String?         // Optional - phone number
  subject         String?         // Optional - default to "Contact Form Inquiry"
  message         String          @db.Text
  status          SubmissionStatus @default(NEW)
  responded       Boolean         @default(false)
  respondedAt     DateTime?
  notes           String?         @db.Text
  ipAddress       String?         @db.Inet
  userAgent       String?         @db.Text
  referer         String?
  emailSent       Boolean         @default(false)
  emailId         String?         // Resend email ID
  emailError      String?         @db.Text
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("contact_submissions")
  @@index([status, createdAt(sort: Desc)])
  @@index([email])
  @@index([createdAt(sort: Desc)])
  @@index([responded])
}

enum SubmissionStatus {
  NEW
  READ
  IN_PROGRESS
  RESPONDED
  ARCHIVED
  SPAM
}

model SecurityEvent {
  id              String              @id @default(cuid())
  type            SecurityEventType
  severity        SecuritySeverity    @default(MEDIUM)
  message         String
  details         Json?               // Structured event data
  ipAddress       String?             @db.Inet
  userAgent       String?             @db.Text
  path            String?
  method          String?             // HTTP method
  clientId        String?             // Hash of IP + UA
  sessionId       String?
  acknowledged    Boolean             @default(false)
  acknowledgedAt  DateTime?
  acknowledgedBy  String?
  createdAt       DateTime            @default(now())

  @@map("security_events")
  @@index([type, createdAt(sort: Desc)])
  @@index([severity, acknowledged])
  @@index([clientId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

enum SecurityEventType {
  RATE_LIMIT_EXCEEDED
  CSRF_VALIDATION_FAILED
  INVALID_INPUT
  SUSPICIOUS_ACTIVITY
  BOT_DETECTED
  BRUTE_FORCE_ATTEMPT
  BLOCKED_REQUEST
  AUTH_FAILURE
  SQL_INJECTION_ATTEMPT
  XSS_ATTEMPT
  UNAUTHORIZED_ACCESS
}

enum SecuritySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}
