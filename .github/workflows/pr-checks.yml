name: PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-large-files:
    name: Check for large file changes
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Check for large file changes
        id: check-files
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          BASE_BRANCH="origin/${{ github.event.pull_request.base.ref }}"

          # Check for files with large changes (>500 lines added in single file)
          LARGE_FILES=$(git diff --numstat $BASE_BRANCH...HEAD | awk '$1 > 500 {print $3 ":" $1}')

          if [ -n "$LARGE_FILES" ]; then
            echo "Large file changes detected:"
            echo "$LARGE_FILES"
            echo "has_large_files=true" >> $GITHUB_OUTPUT

            # Store file info
            echo "LARGE_FILES<<EOF" >> $GITHUB_ENV
            echo "$LARGE_FILES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "has_large_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR if large files detected
        if: steps.check-files.outputs.has_large_files == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const largeFiles = process.env.LARGE_FILES.split('\n').filter(f => f);

            const fileList = largeFiles.map(file => {
              const [path, additions] = file.split(':');
              return `- \`${path}\` (+${additions} lines)`;
            }).join('\n');

            const comment = `## â„¹ï¸ Large File Changes Detected

            The following files have significant changes (>500 lines added):

            ${fileList}

            ### ðŸ“‹ Best Practices Reminder
            - **Consider splitting large changes** into multiple focused PRs
            - **Separate refactoring from feature work** when possible
            - **Data file updates** should ideally be in their own PR
            - **Generated files** should be verified for correctness

            ### âœ… This is Just a Reminder
            Large changes are sometimes necessary. This is an informational comment to help with code review efficiency.

            If these changes are intentional and cannot be reasonably split, you can safely proceed! ðŸš€`;

            // Find existing bot comments
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Large File Changes Detected')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }
